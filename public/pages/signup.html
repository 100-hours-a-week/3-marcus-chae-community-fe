<html>

<head>
    <title>회원가입</title>
    <link rel="stylesheet" href="../css/common.css">
    <style>
        main {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
    </style>
</head>

<body>
    <header-component logged-in="false"></header-component>
    <main>
        <form id="signupForm">
            <input-block label="이메일" type="email" input-id="email"></input-block>
            <input-block label="비밀번호" type="password" input-id="password"></input-block>
            <input-block label="비밀번호 확인" type="password" input-id="passwordConfirm"></input-block>
            <input-block label="닉네임" type="text" input-id="nickname"></input-block>
            <button id="signupButton" type="button"
                disabled>회원가입</button><!--입력값이 전부 유효할 때만 활성화돼야 함. 따라서 유효성 상태 변수, 유효성 검증 로직, 활성 비활성 구분 필요-->
        </form>
        <button id="toLoginPageButton">로그인하러 가기</button>
    </main>

    <footer-component></footer-component>

    <script src="../js/components.js"></script>
    <script>
        console.log("스크립트 로드됨.");

        let emailValidity = false;
        let passwordValidity = false;
        let passwordConfirmValidity = false;
        let nicknameValidity = false;

        // input 요소에 접근
        const email = document.getElementById("email");
        const password = document.getElementById("password");
        const passwordConfirm = document.getElementById("passwordConfirm");
        const nickname = document.getElementById("nickname");
        const signupButton = document.getElementById("signupButton");
        const toLoginPageButton = document.getElementById("toLoginPageButton");
        const logoButton = document.getElementById("logoButton");

        // input-block 컴포넌트에 접근 (에러 메시지 표시용)
        const emailBlock = email.closest('input-block');
        const passwordBlock = password.closest('input-block');
        const passwordConfirmBlock = passwordConfirm.closest('input-block');
        const nicknameBlock = nickname.closest('input-block');

        function updateSignupButtonState() {
            const allValid = emailValidity && passwordValidity && passwordConfirmValidity && nicknameValidity;
            console.log("회원가입 버튼 업데이트. allValid 값:", allValid);
            console.log("이멜 비번 비확 닉넴", emailValidity, passwordValidity, passwordConfirmValidity, nicknameValidity);
            
            signupButton.disabled = !allValid;
        }

        // 회원가입 버튼 눌렸을 때
        signupButton.addEventListener("click", async () => {

            console.log("회원가입 버튼 눌림 감지됨.");

            const response = await fetch("/api/v1/users", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    email: email.value,
                    password: password.value,
                    nickname: nickname.value
                }),
            });

            console.log("응답:", response);

            console.log("회원가입 요청 보내짐");
        });

        email.addEventListener("focusout", (e) => {
            email.value = email.value.trim();
            console.log("입력된 이메일:", email.value);
            console.log("유효한 이메일인가?", email.checkValidity());

            emailValidity = email.checkValidity();
            if (!emailValidity) {
                emailBlock.showError("올바른 이메일 형식이 아닙니다.");
            } else {
                emailBlock.hideError();
            }
            updateSignupButtonState();
        });

        password.addEventListener("focusout", () => {
            const passwordValue = password.value;

            // 8-20자, 대문자/소문자/숫자/특수문자 각 1개 이상, 앞뒤 공백 불허, 중간 공백 허용
            const passwordRegex = /^(?!\s)(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]).{8,20}(?<!\s)$/;
            passwordValidity = passwordRegex.test(passwordValue);
            console.log("비밀번호 유효성:", passwordValidity);

            if (!passwordValidity) {
                passwordBlock.showError("8-20자, 대문자/소문자/숫자/특수문자 각 1개 이상 포함해야 합니다.");
            } else {
                passwordBlock.hideError();
            }

            updateSignupButtonState();
        });

        passwordConfirm.addEventListener("focusout", () => {
            if (!passwordValidity) { return; }

            passwordConfirmValidity = (passwordConfirm.value === password.value);
            console.log("비밀번호 확인 유효성:", passwordConfirmValidity);

            if (!passwordConfirmValidity) {
                passwordConfirmBlock.showError("비밀번호가 일치하지 않습니다.");
            } else {
                passwordConfirmBlock.hideError();
            }

            updateSignupButtonState();
        });

        nickname.addEventListener("focusout", () => {
            const nicknameValue = nickname.value;
            // 닉네임: 1자 이상, 10자 이하 (예시 유효성 검사)
            nicknameValidity = nicknameValue.length > 0 && nicknameValue.length <= 10;
            console.log("닉네임 유효성:", nicknameValidity);

            if (!nicknameValidity) {
                nicknameBlock.showError("닉네임은 10자 이하로 입력해주세요.");
            } else {
                nicknameBlock.hideError();
            }

            updateSignupButtonState();
        });

        toLoginPageButton.addEventListener("click", () => {
            window.location.href = "login.html"
        });
    </script>
</body>

</html>